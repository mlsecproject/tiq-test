---
title: "Measuring the IQ of your Threat Intelligence - Summer 2014"
author: "Alex Pinto & Kyle Maxwell"
date: "August 1, 2014"
output: html_document
---

Adding the TIQ functions
```{r, message=FALSE, cache=TRUE}
source("tiq-test.R")
```

## Acessing the data using TIQ-TEST

We can use the `tiq.data` functions to load the Threat Intelligence datasets from
the database for exploration using R. We have defaulted to the use of `data.table`
objects for this because they are faster and you can write tighter code around it
(sorry Hadleyverse fans).

We have roughly a month of data available on this public dataset:
```{r, message=FALSE, cache=TRUE}
.tiq.data.getAvailableDates("raw", "public_outbound")
```

This is an example of "RAW" (not enriched) outbound data imported from combine output
```{r, message=FALSE, cache=TRUE}
outbound.ti = tiq.data.loadTI("raw", "public_outbound", "20140701")
outbound.ti[, list(entity, type, direction, source, date)]
```

This specific outbound dataset has the following sources included:

```{r, message=FALSE, cache=TRUE}
outbound.ti = tiq.data.loadTI("raw", "public_outbound", "20140701")
unique(outbound.ti$source)
```

We can do the same for the inbound data we have to see the sources we have available:
```{r, message=FALSE, cache=TRUE}
inbound.ti = tiq.data.loadTI("raw", "public_inbound", "20140701")
unique(inbound.ti$source)
```

SIDE NOTE: please don't add non-malicious domains to malware domain lists, ok? :)

```{r, message=FALSE, cache=TRUE}
outbound.ti = tiq.data.loadTI("raw", "public_outbound", "20140701")
outbound.ti[entity %like% "google.com", list(entity, type, direction, source, date)] 
```

We can use the same `loadTI` function to also gather the enriched datasets:
```{r, message=FALSE, cache=TRUE}
enrich.ti = tiq.data.loadTI("enriched", "public_outbound", "20140710")
enrich.ti = enrich.ti[, notes := NULL]
enrich.ti[c(2,22264, 22266)]
```

## Novelty test examples

```{r, cache=TRUE}
  group = "public_inbound"
  start.date = "20140701"
  end.date = "20140715"

  aa = tiq.test.noveltyTest("public_outbound", start.date, end.date, select.sources=NULL)
  tiq.test.plotNoveltyTest(aa)

  aa2 = tiq.test.noveltyTest("public_outbound", start.date, end.date,
                             select.sources=c("alienvault", "zeus"))
  tiq.test.plotNoveltyTest(aa2)

  bb = tiq.test.noveltyTest("public_inbound", start.date, end.date, select.sources=NULL)
  tiq.test.plotNoveltyTest(bb)
```

## Overlap Test Examples

```{r, cache=TRUE}
  group = "public_outbound"
  type = "enriched"
  end.date = "20140715"

  overlap = tiq.test.overlapTest(group, end.date, type, select.sources=NULL)
  print(overlap)
  overlap.plot = tiq.test.plotOverlapTest(overlap, title=paste0("OverlapTest - ", group, " - ", end.date))
  print(overlap.plot)
```

## Population Test Examples (Plots)

```{r, cache=TRUE}
  group = "public_outbound"
  pop.id = "country"
  pop.group = "mmgeo"
  end.date = "20140711"

  pop = tiq.test.extractPopulationFromTI(group, "country", end.date,
                                         select.sources=NULL)
  tiq.test.plotPopulationBars(pop, "country")

  pop = tiq.test.extractPopulationFromTI(group, c("asnumber", "asname"), end.date,
                                         select.sources=NULL)
  tiq.test.plotPopulationBars(pop, "asname")

  pop = tiq.test.extractPopulationFromTI(group, c("asnumber", "asname"), end.date,
                                         select.sources=NULL,
                                         split.ti=FALSE)
  pop.mm = tiq.data.loadPopulation("mmasn", c("asnumber", "asname"))
  tiq.test.plotPopulationBars(c(pop, pop.mm), "asname")

  pop = tiq.test.extractPopulationFromTI("public_inbound", "country", end.date,
                                         select.sources=NULL,
                                         split.ti=FALSE)
  pop.mm = tiq.data.loadPopulation("mmgeo", "country")
  tiq.test.plotPopulationBars(c(pop, pop.mm), "country")
```

## Population Test Examples (Inference - Country)

```{r, cache=TRUE}
  group = "public_outbound"
  pop.group = "mmgeo"
  end.date = "20140711"
  end.date2 = "20140712"

  pop = tiq.test.extractPopulationFromTI(group, "country", end.date,
                                         select.sources=NULL,
                                         split.ti=FALSE)

  pop2 = tiq.test.extractPopulationFromTI(group, "country", end.date2,
                                       select.sources=NULL,
                                       split.ti=FALSE)
  pop.mm = tiq.data.loadPopulation("mmgeo", "country")
```

Comparing the population from day X to day X+1

```{r, cache=TRUE}
ref.pop = pop$public_outbound
test.pop = pop2$public_outbound

tests = tiq.test.populationInference(ref.pop, test.pop, "country",
                                     exact = F, top=-1)

tests[p.value < 0.05 & conf.int.end > 0][order(conf.int.end, decreasing=T)]
tests[p.value < 0.05 & conf.int.start < 0][order(conf.int.start, decreasing=F)]
tests[p.value > 0.05]
```

Comparing the population from day X to the "true" population

```{r, cache=TRUE}
ref.pop = pop.mm$mmgeo
test.pop = pop2$public_outbound

tests = tiq.test.populationInference(ref.pop, test.pop, "country",
                                     exact = F, top=-1)

tests[p.value < 0.05 & conf.int.end > 0][order(conf.int.end, decreasing=T)]
tests[p.value < 0.05 & conf.int.start < 0][order(conf.int.start, decreasing=F)]
tests[p.value > 0.05]
```

## Population Test Examples (Inference - ASN)

```{r, cache=TRUE}
  group = "public_outbound"
  pop.id = "asname"
  pop.group = "mmasn"
  end.date = "20140711"
  end.date2 = "20140712"

  pop = tiq.test.extractPopulationFromTI(group, pop.id, end.date,
                                         select.sources=NULL,
                                         split.ti=FALSE)

  pop2 = tiq.test.extractPopulationFromTI(group, pop.id, end.date2,
                                          select.sources=NULL,
                                          split.ti=FALSE)
  pop.mm = tiq.data.loadPopulation(pop.group, pop.id)

    ref.pop = pop.mm$mmasn
    test.pop = pop$public_outbound

    tests = tiq.test.populationInference(ref.pop, test.pop, pop.id,
                                         exact = TRUE, top=-1)

  tests[p.value < 0.05 & conf.int.end > 0][order(conf.int.end, decreasing=T)]
  tests[p.value < 0.05 & conf.int.start < 0][order(conf.int.start, decreasing=F)]
  tests[p.value > 0.05]

  ref.pop = pop$public_outbound
  test.pop = pop2$public_outbound

  tests = tiq.test.populationInference(ref.pop, test.pop, pop.id,
                                       exact = F, top=-1)

  tests[p.value < 0.05 & conf.int.end > 0][order(conf.int.end, decreasing=T)]
  tests[p.value < 0.05 & conf.int.start < 0][order(conf.int.start, decreasing=F)]
  tests[p.value > 0.05]
```
